import { useState, useRef } from 'react';
import { css } from 'styled-components';
import { ArgsTable, Canvas, Meta, Story, Subtitle, Title } from '@storybook/addon-docs/blocks';
import { Utils } from '../../shared';
import menuAnatomyImg from '../../assets/images/menu-anatomy.png';
import menuExampleImg from '../../assets/images/menu-example.png';
import MenuItem from '../../components/menu-item';
import IconButton from '../../components/icon-button';

import Menu from './Menu';
import Icon from '../../foundations/icon';
import Grid from '../../utilities/layout';
import Spacing from '../../utilities/spacing';
import { DEFAULT_MENU_PLACEMENT, MENU_OFFSET_TOKENS, MENU_PLACEMENTS } from './Menu.constants';
import { useDeviceDetect } from '../../shared';

<Meta title={'Patterns/Menu'} />

<Title>Popover Menu</Title>

<Subtitle>
    A Popover Menu is a way of displaying multiple choices overlayed on top of the current context.
    It displays when interacting with a trigger (such as an icon or button).
</Subtitle>

<img src={menuExampleImg} alt={'menu example'} />

## Anatomy

A Popover Menu is essentially a container that holds the Menu Title, Menu Item, Menu Group Title, or Menu Divider Components.

<img src={menuAnatomyImg} alt={'menu anatomy'} />

### Container

The Container uses a 1px border (16% Center Channel Color) with the Center Channel Background Color as the fill.
It also has an Elevation applied to it that separates it from the background it covers. The default elevation of the container is Elevation 4.

The Container has 8px of space above the first Menu Item, and 8px of space below the last.

### Menu Title (optional)

The Menu Item is the core interactive element of a Popover Menu. See the Menu Item Component for all of its variants.

### Menu Divider (optional)

Menu Dividers are used to separate groups of Menu Items, or to separate the Menu Title from the Menu Items.

### Menu Group

A Menu Group is simply a container that holds related Menu Items.

### Menu Group Title (optional)

Not all Menu Groups need to have a title. Often grouping related items together can be enough without the need for a title.

export const menuArgTypes = {
    title: {
        control: {
            type: 'string',
        },
    },
    width: { control: { type: 'range', min: 1, max: 1000, step: 1 } },
    placement: {
        options: MENU_PLACEMENTS,
        control: {
            type: 'select',
        },
    },
    groups: { table: { disable: true } },
};

export const mainGroup = [
    {
        title: 'Main group',
        menuItems: [
            <MenuItem label="Hello Mattermost" leadingElement={<Icon size={16} glyph="globe" />} />,
            <MenuItem
                label="Edit Mattermost"
                leadingElement={<Icon size={16} glyph="pencil-outline" />}
            />,
        ],
    },
];

export const menuArgs = {
    title: 'Main Menu',
    placement: DEFAULT_MENU_PLACEMENT,
    groups: mainGroup,
};

<ArgsTable of={Menu} />

<Canvas hidden>
    <Story name="default" args={menuArgs} argTypes={menuArgTypes}>
        {(args) => {
            const [isVisible, setIsVisible] = useState(false);
            const reference = useRef(null);
            function toggleVisible() {
                console.log('#### toggle visible');
                setIsVisible(!isVisible);
            }
            return (
                <>
                    <IconButton
                        icon={'menu'}
                        onClick={toggleVisible}
                        ref={reference}
                        toggled={isVisible}
                    />
                    <Menu {...args} trigger={reference} isVisible={isVisible} hasSubmenu={false} />
                </>
            );
        }}
    </Story>
    <Story name="submenu" args={menuArgs} argTypes={menuArgTypes}>
        {(args) => {
            const [isMenuVisible, setMenuVisible] = useState(false);
            const [isSubMenuVisible, setSubMenuVisible] = useState(false);
            const buttonReference = useRef(null);
            const menuItemReference = useRef(null);
            const isMobile = useDeviceDetect();
            function toggleMenu() {
                console.log('#### toggle menu');
                setMenuVisible(!isMenuVisible);
            };
            function toggleSubmenu() {
                console.log('#### toggle submenu');
                setSubMenuVisible(!isSubMenuVisible);
            };
            const menuGroup = [
                {
                    menuItems: [
                        <MenuItem ref={menuItemReference} onMouseEnter={toggleSubmenu} label='Open Submenu' leadingElement={<Icon size={16} glyph='plus'/>} trailingElement={<Icon size={16} glyph='chevron-right'/>}/>,
                        <MenuItem label='Leave Mattermost' leadingElement={<Icon size={16} glyph='sort-alphabetical-ascending'/>}/>,
                        <MenuItem label='Open Mattermost' leadingElement={<Icon size={16} glyph='account-multiple-outline'/>}/>,
                    ]
                },
            ];
            const submenuGroup = [
                {
                    menuItems: [
                        <MenuItem label='Leave Mattermost' leadingElement={<Icon size={16} glyph='sort-alphabetical-ascending'/>}/>,
                        <MenuItem label='Open Mattermost' leadingElement={<Icon size={16} glyph='account-multiple-outline'/>}/>,
                    ]
                },
            ];
            return (
                    <>
                        <IconButton
                            icon={'menu'}
                            onClick={toggleMenu}
                            ref={buttonReference}
                            toggled={isMenuVisible}
                        />
                        <Menu {...args} onClickAway={() => setMenuVisible(false)} groups={menuGroup} trigger={buttonReference} isVisible={isMenuVisible} hasSubmenu={false} />
                        <Menu
                            {...args}
                            title={isMobile ? <MenuItem
                                                ref={menuItemReference}
                                                    onMouseEnter={toggleSubmenu}
                                                    label='Open Submenu'
                                                    leadingElement={<Icon size={16} glyph='chevron-left'/>}
                                                /> : undefined}
                            onClickAway={() => setSubMenuVisible(false)} 
                            trigger={menuItemReference}
                            isVisible={isSubMenuVisible}
                            groups={submenuGroup}
                            placement={'right'}
                        />
                </>
            );
        }}
    </Story>
</Canvas>
